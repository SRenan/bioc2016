---
title: "Introduction to ImmuneSpaceR, BioC 2016"
date: "`r Sys.Date()`"
output: html_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Introduction to ImmuneSpaceR}
---
```{r knitr-opts, echo = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE)
opts_chunk$set(fig.align = "center", fig.width = 10)
```

## Instantiate connections
```{r connection}
# Connections
library(ImmuneSpaceR)
con <- CreateConnection("SDY269", login = "bioc2016@immunespace.org", password = "HIPCbc16")
con
```

## Fetching data sets
```{r getDatasets}
library(data.table)
# Datasets
hai <- con$getDataset("hai")
head(hai)
hai <- con$getDataset("hai", original_view = TRUE)
head(hai)
```
### Dataset filtering
```{r datasets-filters}
library(Rlabkey)
virus_filter <- makeFilter(c("virus", "CONTAINS", "H1N1"))
hai_f <- con$getDataset("hai", colFilter = virus_filter)
virus_filter2 <- makeFilter(c("virus", "EQUAL", "A/Brisbane/59/2007 (H1N1)"))
hai_f <- con$getDataset("hai", colFilter = virus_filter2)

analyte_filter <- makeFilter(c("Analyte", "EQUAL", "IFNg"), c("Study time collected", "IN", "0;7"))
elisa <- con$getDataset("elisa", colFilter = analyte_filter)
```

## Cross assay analysis
```{r cross-assay}
# Cross assay
analyte_filter2 <- makeFilter(c("Analyte", "EQUAL", "IgG"), c("Study time collected", "EQUAL", "7"))
elispot <- con$getDataset("elispot", colFilter = analyte_filter2, reload = TRUE)
elispot <- elispot[, elispot_response := spot_number_reported + 1]
elispot <- elispot[, list(participant_id, elispot_response)]

fcs <- con$getDataset("fcs_analyzed_result")
fcs <- fcs[, fcs_response := (as.double(population_cell_number) + 1) / as.double(base_parent_population)][study_time_collected == 7]
res <- merge(elispot, fcs, by = "participant_id")

library(ggplot2)
ggplot(res, aes(x = as.double(fcs_response), y = elispot_response, color = cohort)) +
  geom_point() + scale_y_log10() + scale_x_log10() + geom_smooth(method = "lm") + 
  xlab("Total plasmablasts (%)") + ylab("Influenza specific cells\n (per 10^6 PBMCs)") +
  theme_IS()
```

## Quick-plot
```{r quick-plot}
# QP
con$quick_plot("hai", normalize = FALSE)
con$quick_plot("hai", filter = virus_filter2, normalize = FALSE, color = "Age", shape = "Gender")
```

## Expression matrices
```{r getGEM}
# Expression
con$listDatasets(which = "expression")
em <- con$getGEMatrix(x = "TIV_2008")
em <- con$getGEMatrix(cohort = "TIV Group 2008")
em <- con$getGEMatrix("TIV_2008", summary = TRUE)
library(Biobase)
head(pData(em))
```

```{r getGEM-cross-cohorts}
ems <- con$getGEMatrix(c("TIV_2008", "LAIV_2008"), summary = TRUE) #Summary usually better for cross cohort (& cross study)
```

## Cross-study connections
```{r connection-cross-study}
# Cross study
all <- CreateConnection("", login = "bioc2016@immunespace.org", password = "HIPCbc16")
all$listDatasets()
```

### Datasets
```{r dataset cross-study}
ahai <- all$getDataset("hai")
virus_filter3 <- makeFilter(c("cohort", "contains", "TIV"))
ahai <- all$getDataset("hai", colFilter = virus_filter3)
all$quick_plot("hai", filter = virus_filter3, normalize = TRUE)
```

### Expression matrices
```{r getGEM-cross-study}
## EM cross-study
csem <- all$getGEMatrix(c("SDY63_young_PBMC_year1", "SDY404_young_PBMC_year2"), summary = TRUE)
```

## Live reports using ImmuneSpaceR
The reports available on ImmuneSpace ([SDY144](https://www.immunespace.org/reports/Studies/SDY144/runReport.view?reportId=module%3ASDY144%2Freports%2Fschemas%2Fstudy%2Fdemographics%2FHAI_VN_vs_plasma_cells.Rmd&redirectUrl=%2Fproject%2FStudies%2FSDY144%2Fbegin.view%3FpageId%3DReports))
are written using ImmuneSpaceR. The code is available and will work both through 
LabKey's report on the web portal and locally.

![](/home/rsautera/workspace/git/bioc2016/inst/img/sdy180report_cropped.png)

## Future
- Rework the instantiation to allow connection to a subset of studies 
    `CreateConnection(c("SDY61", "SDY269"))`
- Use [Data Finder](https://www.immunespace.org/project/Studies/begin.view) filters in R
- Integration of Rstudio to ImmuneSpace (spawn pre-filtered R sessions)
- Accept user made R/Rmd reports on ImmuneSpace
- Improve testing of both ImmuneSpaceR & ImmuneSpace

